<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Record Collection</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style/main.css" />
  <script src="scripts/jsstore.js "></script>
  <script>
    var connection = new JsStore.Instance(new Worker('scripts/jsstore.worker.js'));
    window.onload = function () {
      initiateDb();
      $('#container').on('click', '.edit', function () {
        var RecordId = $(this).parents().eq(1).attr('itemid');
        window.location.href = 'add.html?id=' + RecordId;
      });
      $('#container').on('click', '.delete', function () {
        var RecordId = $(this).parents().eq(1).attr('itemid');
        deleteData(RecordId);
      });
    };

    // delete record
    function deleteData(recordId) {
      connection.remove({
        from: 'Record',
        where: {
          Id: Number(recordId)
        }
      }).then(function (rowsDeleted) {
        console.log(rowsDeleted + ' rows deleted');
        if (rowsDeleted > 0) {
          buildArtist();
        }
      }).catch(function (err) {
        console.log(err.message);
      });
    }

    function initiateDb() {
      var DbName = 'Records';
      connection.isDbExist(DbName).then(function (isExist) {
        if (isExist) {
          connection.openDb(DbName).then(function () {
            console.log('db opened');
          });
          buildArtist();
        }
      }).catch(function (err) {
        console.log(err);
      });
    }

    function getParam(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, '\\$&');
      var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function buildArtist() {
      var artist = getParam('artist');
      connection.select({
        from: 'Record',
        where: {
          Artist: artist
        }
      }).then(function (records) {
        // get the artist
        function getArtist(set, properties) {
          return set.filter(function (entry) {
            return Object.keys(properties).every(function (key) {
              return entry[key] === properties[key];
            });
          });
        }
        var results = getArtist(records, { Artist: artist });
        $('#artistName').html(artist + ' (' + results.length + ')');

        // show all records by artist
        if (records.length === 0) {
          window.location.href = 'index.html';
        }
        var HtmlString = '';
        records.forEach(function (record) {
          HtmlString += "<div ItemId=" + record.Id + ">" +
            "<div class='coreMod'><a href='artist.html?artist=" + encodeURIComponent(record.Artist) + "'>" + record.Artist + "</a></div>" +
            "<div class='coreMod'>" + record.Album + "</div>" +
            "<div class='coreMod'>" + record.Year + "</div>" +
            "<div class='coreMod'>" + record.Condition + "</div>" +
            "<div class='coreMod'>" + record.Tags + "</div>" +
            "<div class='coreMod'><a href='#' class='edit'>Edit</a></div>" +
            "<div class='coreMod'><a href='#' class='delete'>Delete</a></div></div>";
        })
        $('#dashCore').html(HtmlString);

        // pull years from artist and sort
        var artistTotalYears = [];
        for (var i = 0; i < results.length; i++) {
          var years = results[i].Year;
          artistTotalYears.push(years);
        }
        var artistUniqueYears = [...new Set(artistTotalYears)];

        // count records per year
        albumCount = [];
        artistTotalYears.sort((a, b) => a - b).forEach(function(obj) {
          var key = JSON.stringify(obj);
          albumCount[key] = (albumCount[key] || 0) + 1;
        });
        albumTotalCount = Object.values(albumCount)

        // chart
        new Chart(document.getElementById('bar-chart'), {
          type: 'bar',
          data: {
            labels: artistUniqueYears.sort((a, b) => a - b),
            datasets: [{
              label: 'Albums',
              data: albumTotalCount,
              backgroundColor: 'rgba(9, 100, 170, 1)',
            }]
          },
          options: {
            scales: {
              yAxes: [{
                ticks: {
                  beginAtZero: true,
                  callback: function(value) {if (Number.isInteger(value)) {return value;}},
                  stepSize: 1
                }
              }]
            }
          }
        });
      }).catch(function(error) {
        console.log(error);
      });
    }

    // search records
    function Find() {
      var searchQry = $('#search').val();
      window.location.href = 'search.html?query=' + searchQry;
    }
  </script>
</head>
<body>
<header>
  <span id="artistName"></span>
  <a href="index.html">Home</a>
</header>
<div class="strip">
  <div class="search">
    <div class="searchRow">
      <div class="input-6">
        <input type="text" class="" id="search" placeholder="Search" />
      </div>
      <button id="btnFind" onclick="Find();">
        Find
      </button>
    </div>
  </div>
</div>
<div id="container">
  <div id="dashHead">
    <div class="headMod">Artist</div>
    <div class="headMod">Album</div>
    <div class="headMod">Year</div>
    <div class="headMod">Condition</div>
    <div class="headMod">Tags</div>
    <div class="headMod"></div>
    <div class="headMod"></div>
  </div>
  <div id="noRecords">You have no records.</div>
  <div id="dashCore"></div>
  <div id="artistChart">
    <canvas id="bar-chart" width="500" height="300"></canvas>
  </div>
</div>
</body>
</html>